<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å„²å€¼ç®¡ç†ç³»çµ± (æ”¯æ´é›²ç«¯åŒæ­¥)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #F3F4F6; -webkit-tap-highlight-color: transparent; }
        .page-section { display: none; padding-bottom: 220px; animation: fadeIn 0.3s ease-in-out; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card-shadow { box-shadow: 0 4px 20px rgba(0,0,0,0.05); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .gradient-bg { background: linear-gradient(135deg, #FF9F43 0%, #FF6B6B 100%); }
        .glass-header { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .chip-active { background-color: #FF6B6B; color: white; }
        .chip-inactive { background-color: #fff; color: #666; border: 1px solid #eee; }
        .loading-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: center; justify-content: center; color: white; flex-direction: column; }
    </style>
</head>
<body class="text-gray-700">

    <!-- Loading UI -->
    <div id="loading-ui" class="loading-overlay">
        <i class="fa-solid fa-spinner fa-spin text-4xl mb-2"></i>
        <span>åŒæ­¥è³‡æ–™ä¸­...</span>
    </div>

    <!-- Fixed Header -->
    <header class="fixed top-0 left-0 right-0 z-50 glass-header shadow-sm border-b border-gray-100 h-16 flex items-center justify-between px-4">
        <div class="flex items-center">
            <div class="w-8 h-8 rounded-lg gradient-bg flex items-center justify-center text-white font-bold mr-3 shadow-md">
                <i class="fa-solid fa-store"></i>
            </div>
            <h1 id="page-title" class="text-lg font-bold text-gray-800">é¦–é </h1>
        </div>
        <button onclick="goToHome()" class="text-gray-400 hover:text-orange-500 transition-colors">
            <i class="fa-solid fa-house text-xl"></i>
        </button>
    </header>

    <main class="pt-20 px-4 max-w-md mx-auto min-h-screen relative">
        
        <!-- HOME PAGE -->
        <div id="page-home" class="page-section active" style="padding-bottom: 80px;">
            <div class="grid grid-cols-2 gap-4">
                <button onclick="navTo('page-shop')" class="col-span-2 gradient-bg text-white p-6 rounded-3xl shadow-lg transform active:scale-95 transition-transform flex flex-col items-center justify-center gap-2">
                    <i class="fa-solid fa-cart-shopping text-3xl"></i>
                    <span class="text-xl font-bold">å•†å“è³¼è²·</span>
                    <span class="text-xs opacity-90">çµå¸³ã€æ‰£æ¬¾ã€ç´€éŒ„</span>
                </button>

                <button onclick="navTo('page-customers')" class="bg-white p-5 rounded-2xl card-shadow flex flex-col items-center gap-2 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-full bg-blue-100 text-blue-500 flex items-center justify-center"><i class="fa-solid fa-user-plus"></i></div>
                    <span class="font-bold text-sm">å®¢æˆ¶ç®¡ç†</span>
                </button>

                <button onclick="navTo('page-deposit')" class="bg-white p-5 rounded-2xl card-shadow flex flex-col items-center gap-2 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-full bg-green-100 text-green-500 flex items-center justify-center"><i class="fa-solid fa-hand-holding-dollar"></i></div>
                    <span class="font-bold text-sm">å„²å€¼ä½œæ¥­</span>
                </button>

                <button onclick="navTo('page-products')" class="bg-white p-5 rounded-2xl card-shadow flex flex-col items-center gap-2 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-500 flex items-center justify-center"><i class="fa-solid fa-box-open"></i></div>
                    <span class="font-bold text-sm">å•†å“è¨­å®š</span>
                </button>

                <button onclick="navTo('page-history')" class="bg-white p-5 rounded-2xl card-shadow flex flex-col items-center gap-2 active:bg-gray-50">
                    <div class="w-10 h-10 rounded-full bg-orange-100 text-orange-500 flex items-center justify-center"><i class="fa-solid fa-clock-rotate-left"></i></div>
                    <span class="font-bold text-sm">è³¼è²·ç´€éŒ„</span>
                </button>
            </div>

            <!-- Cloud Sync & Settings -->
            <div class="mt-6 space-y-4">
                <div class="bg-white rounded-2xl p-4 card-shadow border-2 border-orange-100">
                    <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-cloud-arrow-down text-blue-500"></i> é›²ç«¯å‚™ä»½åŒæ­¥
                    </h3>
                    <div class="text-[10px] text-gray-400 mb-3">æ¸…é™¤ç€è¦½å™¨ç´€éŒ„å‰ï¼Œè«‹å…ˆæŒ‰åŒæ­¥ä»¥å…è³‡æ–™éºå¤±ã€‚</div>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="pullFromCloud()" class="bg-blue-500 text-white text-xs py-2.5 rounded-lg font-bold">
                            <i class="fa-solid fa-download mr-1"></i> ä¸‹è¼‰é›²ç«¯è³‡æ–™
                        </button>
                        <button onclick="pushToCloud()" class="bg-gray-800 text-white text-xs py-2.5 rounded-lg font-bold">
                            <i class="fa-solid fa-upload mr-1"></i> ä¸Šå‚³å…¨é‡å‚™ä»½
                        </button>
                    </div>
                    <div id="sync-status" class="mt-2 text-[10px] text-center text-gray-400">å°šæœªåŒæ­¥</div>
                </div>

                <div class="bg-white rounded-2xl p-4 card-shadow">
                    <h3 class="font-bold text-gray-800 mb-2 flex items-center gap-2">
                        <i class="fa-brands fa-google text-green-600"></i> Google Sheet URL
                    </h3>
                    <input type="text" id="gsheet-url" placeholder="è²¼ä¸Š Web App URL..." class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm focus:outline-none focus:border-orange-400">
                    <button onclick="saveSettings()" class="mt-2 w-full bg-gray-200 text-gray-700 text-xs py-2 rounded-lg font-bold">å„²å­˜è¨­å®š</button>
                </div>
            </div>
        </div>

        <!-- 1. CUSTOMER PAGE -->
        <div id="page-customers" class="page-section">
            <div class="bg-white rounded-2xl p-4 card-shadow mb-4">
                <h3 class="font-bold text-lg mb-4 text-orange-500">æ–°å¢/ä¿®æ”¹å®¢æˆ¶</h3>
                <input type="hidden" id="cust-id">
                <div class="space-y-3">
                    <input type="text" id="cust-name" placeholder="å§“å" class="w-full bg-gray-50 p-3 rounded-xl border-none">
                    <input type="tel" id="cust-phone" placeholder="é›»è©±" class="w-full bg-gray-50 p-3 rounded-xl border-none">
                    <input type="text" id="cust-address" placeholder="åœ°å€" class="w-full bg-gray-50 p-3 rounded-xl border-none">
                    <div class="flex gap-2">
                        <button onclick="saveCustomer()" class="flex-1 bg-orange-500 text-white py-3 rounded-xl font-bold">å„²å­˜å®¢æˆ¶</button>
                        <button onclick="clearCustomerForm()" class="px-4 bg-gray-200 text-gray-600 rounded-xl font-bold">é‡ç½®</button>
                    </div>
                </div>
            </div>
            <h3 class="font-bold text-gray-600 mb-2 pl-1">å®¢æˆ¶åˆ—è¡¨</h3>
            <div class="relative"><i class="fa-solid fa-search absolute left-3 top-3.5 text-gray-400"></i><input type="text" id="cust-search" oninput="renderCustomerList()" placeholder="æœå°‹å§“åæˆ–é›»è©±..." class="w-full pl-10 pr-4 py-3 rounded-xl bg-white border-none shadow-sm mb-4"></div>
            <div id="customer-list" class="space-y-3"></div>
        </div>

        <!-- 2. DEPOSIT PAGE -->
        <div id="page-deposit" class="page-section">
            <div class="bg-white rounded-2xl p-5 card-shadow mb-4">
                <label class="block text-sm font-bold text-gray-500 mb-1">é¸æ“‡å®¢æˆ¶</label>
                <select id="deposit-cust-select" class="w-full bg-gray-50 p-3 rounded-xl border-none mb-4 font-bold text-gray-700"><option value="">è«‹é¸æ“‡...</option></select>
                <label class="block text-sm font-bold text-gray-500 mb-1">å„²å€¼é‡‘é¡</label>
                <input type="number" id="deposit-amount" class="w-full bg-gray-50 p-3 rounded-xl border-none mb-4 text-xl font-bold text-orange-600">
                <label class="block text-sm font-bold text-gray-500 mb-1">è´ˆé€é‡‘é¡</label>
                <input type="number" id="deposit-bonus" class="w-full bg-gray-50 p-3 rounded-xl border-none mb-6">
                <button onclick="processDeposit()" class="w-full gradient-bg text-white py-4 rounded-xl font-bold text-lg shadow-lg">ç¢ºèªå„²å€¼</button>
            </div>
        </div>

        <!-- 4. PRODUCT PAGE -->
        <div id="page-products" class="page-section">
            <div class="flex justify-end mb-2"><button onclick="toggleCategoryManager()" class="text-sm text-purple-600 font-bold bg-purple-50 px-3 py-1 rounded-lg"><i class="fa-solid fa-list-ul"></i> ç®¡ç†åˆ†é¡</button></div>
            <div id="category-manager" class="hidden bg-white rounded-2xl p-4 card-shadow mb-4 border border-purple-100">
                <h4 class="font-bold text-gray-700 mb-2">åˆ†é¡ç®¡ç†</h4>
                <div class="flex gap-2 mb-3"><input type="text" id="new-cat-name" placeholder="æ–°åˆ†é¡" class="flex-1 bg-gray-50 px-3 py-2 rounded-lg text-sm"><button onclick="addCategory()" class="bg-purple-500 text-white px-4 rounded-lg text-sm">æ–°å¢</button></div>
                <div id="category-list-edit" class="flex flex-wrap gap-2"></div>
            </div>
            <div class="bg-white rounded-2xl p-4 card-shadow mb-4">
                <h3 class="font-bold text-lg mb-4 text-purple-600">å•†å“è¨­å®š</h3>
                <input type="hidden" id="prod-id">
                <div class="mb-3"><label class="block text-xs text-gray-400 mb-1">åˆ†é¡</label><select id="prod-category" class="w-full bg-gray-50 p-3 rounded-xl border-none"></select></div>
                <div class="grid grid-cols-3 gap-3 mb-3">
                    <input type="text" id="prod-name" placeholder="åç¨±" class="col-span-2 bg-gray-50 p-3 rounded-xl border-none">
                    <input type="number" id="prod-price" placeholder="åƒ¹æ ¼" class="col-span-1 bg-gray-50 p-3 rounded-xl border-none">
                </div>
                <div class="flex gap-2"><button onclick="saveProduct()" class="flex-1 bg-purple-500 text-white py-3 rounded-xl font-bold">å„²å­˜</button><button onclick="clearProductForm()" class="px-4 bg-gray-200 text-gray-600 rounded-xl font-bold">é‡ç½®</button></div>
            </div>
            <div id="product-list" class="space-y-3"></div>
        </div>

        <!-- 5. SHOP PAGE -->
        <div id="page-shop" class="page-section">
            <div class="bg-white rounded-2xl p-4 card-shadow mb-4 sticky top-16 z-20">
                <div class="flex justify-between items-center mb-2"><label class="text-sm font-bold text-gray-500">è³¼è²·äºº</label><span id="shop-balance-display" class="text-sm font-bold text-orange-500 bg-orange-50 px-2 py-1 rounded-lg"></span></div>
                <select id="shop-cust-select" onchange="updateShopBalance()" class="w-full bg-gray-50 p-2 rounded-lg border-none font-bold text-gray-800"><option value="">-- è¨ªå®¢ --</option></select>
            </div>
            <div class="flex overflow-x-auto gap-2 mb-4 no-scrollbar py-2" id="shop-cat-chips"></div>
            <div id="shop-product-list" class="grid grid-cols-1 gap-3 mb-6"></div>

            <div class="bg-white rounded-t-3xl shadow-[0_-4px_30px_rgba(0,0,0,0.1)] fixed bottom-0 left-0 right-0 px-5 pt-5 pb-6 z-40 max-w-md mx-auto">
                <div class="mb-4 bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs text-gray-500 font-bold">æŠ˜æ‰£ (%)</label>
                        <div class="flex gap-1 text-[10px] bg-white p-1 rounded-lg border border-gray-200">
                            <label class="flex items-center gap-1 cursor-pointer px-1"><input type="radio" name="round" value="round" checked onclick="calculateTotal()">å››æ¨</label>
                            <label class="flex items-center gap-1 cursor-pointer px-1"><input type="radio" name="round" value="floor" onclick="calculateTotal()">å»å°æ•¸</label>
                            <label class="flex items-center gap-1 cursor-pointer px-1"><input type="radio" name="round" value="ceil" onclick="calculateTotal()">é€²ä½</label>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="discount-rate" value="100" oninput="calculateTotal()" class="w-16 bg-white border rounded-lg p-1 text-center font-bold text-orange-600">
                        <span class="text-xs text-gray-400">%</span>
                        <div class="flex-1 text-right text-xs text-red-400 font-bold" id="discount-display"></div>
                    </div>
                </div>
                <div class="flex justify-between items-end mb-4 border-b pb-4">
                    <div><div class="text-xs text-gray-400">æŠ˜å¾Œç¸½é¡</div><div class="text-3xl font-bold text-gray-800">$<span id="cart-total">0</span></div></div>
                    <select id="payment-method" class="bg-gray-100 rounded-lg text-sm p-1 font-bold w-32"><option value="cash">ğŸ’µ ç¾é‡‘</option><option value="linepay">ğŸ“± LINE PAY</option><option value="stored">ğŸ’° å„²å€¼æ‰£æ¬¾</option></select>
                </div>
                <button onclick="processCheckout()" class="w-full gradient-bg text-white py-3 rounded-xl font-bold">ç¢ºèªçµå¸³</button>
            </div>
            <div style="height: 300px;"></div>
        </div>

        <!-- 6. HISTORY PAGE -->
        <div id="page-history" class="page-section"><div id="history-list" class="space-y-3"></div></div>

        <!-- GLOBAL: Return Home -->
        <div id="btn-return-home" class="fixed bottom-6 left-1/2 transform -translate-x-1/2 z-30 hidden">
            <button onclick="goToHome()" class="bg-gray-800 text-white px-6 py-3 rounded-full shadow-xl font-bold text-sm"><i class="fa-solid fa-house"></i> è¿”å›é¦–é </button>
        </div>

    </main>

    <!-- MODAL -->
    <div id="result-modal" class="fixed inset-0 z-[60] hidden flex items-center justify-center bg-black bg-opacity-50 px-4 backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-full max-w-sm shadow-2xl">
            <div class="text-center mb-4"><div class="w-12 h-12 bg-green-100 text-green-500 rounded-full flex items-center justify-center mx-auto mb-2 text-xl"><i class="fa-solid fa-check"></i></div><h3 class="text-lg font-bold">æˆåŠŸ</h3></div>
            <textarea id="copy-target" class="w-full bg-gray-50 p-3 rounded-xl text-sm h-32 resize-none mb-4" readonly></textarea>
            <div class="grid grid-cols-2 gap-3"><button onclick="copyText()" class="bg-gray-800 text-white py-3 rounded-xl font-bold text-sm">è¤‡è£½æ–‡å­—</button><button onclick="closeModal()" class="bg-gray-200 text-gray-700 py-3 rounded-xl font-bold text-sm">é—œé–‰</button></div>
        </div>
    </div>

    <script>
        // --- DATA ---
        let customers = JSON.parse(localStorage.getItem('sm_customers')) || [];
        let products = JSON.parse(localStorage.getItem('sm_products')) || [];
        let transactions = JSON.parse(localStorage.getItem('sm_transactions')) || [];
        let categories = JSON.parse(localStorage.getItem('sm_categories')) || ['æœªåˆ†é¡'];
        let appSettings = JSON.parse(localStorage.getItem('sm_settings')) || { sheetUrl: '' };
        let cart = {};
        let currentShopCategory = 'All';

        // --- CLOUD SYNC LOGIC ---
        async function pullFromCloud() {
            if(!appSettings.sheetUrl) return alert('è«‹å…ˆè¨­å®š Google Sheet URL');
            showLoading(true);
            try {
                // å‡è¨­æ‚¨çš„ Script æ”¯æ´ GET ä¸¦å›å‚³å…¨é‡ JSON
                const response = await fetch(`${appSettings.sheetUrl}?action=pull`);
                const result = await response.json();
                
                if(result.status === 'success') {
                    const d = result.data;
                    customers = d.customers || [];
                    products = d.products || [];
                    transactions = d.transactions || [];
                    categories = d.categories || ['æœªåˆ†é¡'];
                    
                    saveAllToLocal();
                    document.getElementById('sync-status').textContent = 'æœ€å¾ŒåŒæ­¥: ' + new Date().toLocaleString();
                    alert('é›²ç«¯è³‡æ–™ä¸‹è¼‰æˆåŠŸï¼');
                    navTo('page-home');
                }
            } catch (e) {
                console.error(e);
                alert('ä¸‹è¼‰å¤±æ•—ï¼Œè«‹æª¢æŸ¥ URL æ˜¯å¦æ­£ç¢ºæˆ– Script æ˜¯å¦æœ‰å›å‚³æ­£ç¢ºæ ¼å¼ã€‚');
            }
            showLoading(false);
        }

        async function pushToCloud() {
            if(!appSettings.sheetUrl) return alert('è«‹å…ˆè¨­å®š Google Sheet URL');
            if(!confirm('é€™å°‡æœƒç”¨ç›®å‰æ‰‹æ©Ÿä¸Šçš„è³‡æ–™è¦†è“‹é›²ç«¯å‚™ä»½ï¼Œç¢ºå®šå—ï¼Ÿ')) return;
            
            showLoading(true);
            const allData = { customers, products, transactions, categories };
            try {
                await syncToGoogleSheet('full_push', allData);
                document.getElementById('sync-status').textContent = 'æœ€å¾Œå‚™ä»½: ' + new Date().toLocaleString();
                alert('å…¨é‡å‚™ä»½æˆåŠŸï¼');
            } catch (e) {
                alert('ä¸Šå‚³å¤±æ•—');
            }
            showLoading(false);
        }

        function saveAllToLocal() {
            localStorage.setItem('sm_customers', JSON.stringify(customers));
            localStorage.setItem('sm_products', JSON.stringify(products));
            localStorage.setItem('sm_transactions', JSON.stringify(transactions));
            localStorage.setItem('sm_categories', JSON.stringify(categories));
        }

        function showLoading(show) {
            document.getElementById('loading-ui').style.display = show ? 'flex' : 'none';
        }

        // --- NAVIGATION ---
        function navTo(pageId) {
            document.querySelectorAll('.page-section').forEach(el => el.classList.remove('active'));
            document.getElementById(pageId).classList.add('active');
            const titles = { 'page-home': 'é¦–é ', 'page-customers': 'å®¢æˆ¶ç®¡ç†', 'page-deposit': 'å„²å€¼ä¸­å¿ƒ', 'page-products': 'å•†å“è¨­å®š', 'page-shop': 'å•†å“è³¼è²·', 'page-history': 'ç´€éŒ„' };
            document.getElementById('page-title').textContent = titles[pageId];
            const homeBtn = document.getElementById('btn-return-home');
            if(pageId === 'page-home') { homeBtn.classList.add('hidden'); } 
            else { 
                homeBtn.classList.remove('hidden'); 
                if(pageId === 'page-customers') renderCustomerList();
                if(pageId === 'page-products') { renderProductList(); renderCategoryManager(); }
                if(pageId === 'page-shop') initShop();
                if(pageId === 'page-deposit') initDeposit();
                if(pageId === 'page-history') renderHistory();
            }
            window.scrollTo(0, 0);
        }

        function goToHome() { navTo('page-home'); }

        // --- SETTINGS ---
        function saveSettings() {
            appSettings.sheetUrl = document.getElementById('gsheet-url').value.trim();
            localStorage.setItem('sm_settings', JSON.stringify(appSettings));
            alert('è¨­å®šå„²å­˜ï¼');
        }

        // --- CUSTOMER ---
        function saveCustomer() {
            const id = document.getElementById('cust-id').value;
            const name = document.getElementById('cust-name').value.trim();
            const phone = document.getElementById('cust-phone').value.trim();
            const address = document.getElementById('cust-address').value.trim();
            if (!name) return;
            if (id) {
                const idx = customers.findIndex(c => c.id == id);
                if (idx > -1) customers[idx] = { ...customers[idx], name, phone, address };
            } else {
                customers.push({ id: Date.now().toString(), name, phone, address, balance: 0, joinedAt: new Date().toISOString() });
            }
            saveAllToLocal();
            clearCustomerForm();
            renderCustomerList();
            syncToGoogleSheet('customer_update', {name, phone, address});
        }
        function renderCustomerList() {
            const listEl = document.getElementById('customer-list');
            const s = document.getElementById('cust-search').value.toLowerCase();
            listEl.innerHTML = '';
            customers.forEach(c => {
                if(c.name.includes(s) || c.phone.includes(s)) {
                    const el = document.createElement('div');
                    el.className = 'bg-white p-4 rounded-2xl card-shadow flex justify-between items-center';
                    el.innerHTML = `<div><div class="font-bold">${c.name}</div><div class="text-xs text-gray-400">${c.phone}</div></div><div class="text-right"><div class="font-bold text-orange-500">$${c.balance}</div><button onclick="editCustomer('${c.id}')" class="text-xs text-blue-500">ä¿®æ”¹</button></div>`;
                    listEl.appendChild(el);
                }
            });
        }
        function editCustomer(id) {
            const c = customers.find(x => x.id == id);
            if(c) {
                document.getElementById('cust-id').value = c.id;
                document.getElementById('cust-name').value = c.name;
                document.getElementById('cust-phone').value = c.phone;
                document.getElementById('cust-address').value = c.address;
                window.scrollTo(0,0);
            }
        }
        function clearCustomerForm() {
            ['cust-id','cust-name','cust-phone','cust-address'].forEach(id => document.getElementById(id).value = '');
        }

        // --- DEPOSIT ---
        function initDeposit() {
            const sel = document.getElementById('deposit-cust-select');
            sel.innerHTML = '<option value="">é¸æ“‡å®¢æˆ¶...</option>';
            customers.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name} (${c.balance})</option>`);
        }
        function processDeposit() {
            const id = document.getElementById('deposit-cust-select').value;
            const amt = parseInt(document.getElementById('deposit-amount').value) || 0;
            const bns = parseInt(document.getElementById('deposit-bonus').value) || 0;
            if(!id || (amt+bns <= 0)) return;
            const idx = customers.findIndex(c => c.id == id);
            customers[idx].balance += (amt + bns);
            const rec = { id: Date.now().toString(), date: new Date().toLocaleString(), type: 'deposit', custName: customers[idx].name, amount: (amt+bns), details: `å„²å€¼:${amt} è´ˆé€:${bns}` };
            transactions.unshift(rec);
            saveAllToLocal();
            showResultModal('å„²å€¼æˆåŠŸ', `å§“åï¼š${customers[idx].name}\nå„²å€¼å¾Œé¤˜é¡ï¼š${customers[idx].balance}`);
            syncToGoogleSheet('deposit', rec);
            initDeposit();
        }

        // --- PRODUCT & CATEGORY ---
        function toggleCategoryManager() { document.getElementById('category-manager').classList.toggle('hidden'); }
        function addCategory() {
            const n = document.getElementById('new-cat-name').value.trim();
            if(n && !categories.includes(n)) { categories.push(n); saveAllToLocal(); renderCategoryManager(); }
        }
        function renderCategoryManager() {
            const list = document.getElementById('category-list-edit');
            list.innerHTML = '';
            categories.forEach(c => {
                const el = document.createElement('div');
                el.className = 'bg-gray-100 px-2 py-1 rounded-lg text-xs';
                el.textContent = c;
                list.appendChild(el);
            });
            const sel = document.getElementById('prod-category');
            sel.innerHTML = '';
            categories.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
        }
        function saveProduct() {
            const id = document.getElementById('prod-id').value;
            const name = document.getElementById('prod-name').value.trim();
            const price = parseInt(document.getElementById('prod-price').value) || 0;
            const cat = document.getElementById('prod-category').value;
            if(!name) return;
            if(id) {
                const idx = products.findIndex(p => p.id == id);
                products[idx] = { ...products[idx], name, price, category: cat };
            } else {
                products.push({ id: Date.now().toString(), name, price, category: cat, hidden: false });
            }
            saveAllToLocal();
            clearProductForm();
            renderProductList();
        }
        function renderProductList() {
            const list = document.getElementById('product-list');
            list.innerHTML = '';
            products.forEach(p => {
                const el = document.createElement('div');
                el.className = `bg-white p-3 rounded-xl flex justify-between items-center ${p.hidden ? 'opacity-50' : ''}`;
                el.innerHTML = `<div><div class="text-[10px] text-gray-400">${p.category}</div><div class="font-bold">${p.name}</div></div><div class="flex gap-2"><button onclick="toggleProd('${p.id}')"><i class="fa-solid ${p.hidden?'fa-eye-slash':'fa-eye'}"></i></button><button onclick="editProd('${p.id}')" class="text-blue-500">æ”¹</button></div>`;
                list.appendChild(el);
            });
        }
        function toggleProd(id) { 
            const idx = products.findIndex(p => p.id == id); 
            products[idx].hidden = !products[idx].hidden; 
            saveAllToLocal(); renderProductList(); 
        }
        function editProd(id) {
            const p = products.find(x => x.id == id);
            if(p) { document.getElementById('prod-id').value=p.id; document.getElementById('prod-name').value=p.name; document.getElementById('prod-price').value=p.price; document.getElementById('prod-category').value=p.category; }
        }
        function clearProductForm() { document.getElementById('prod-id').value=''; document.getElementById('prod-name').value=''; document.getElementById('prod-price').value=''; }

        // --- SHOP ---
        function initShop() {
            const sel = document.getElementById('shop-cust-select');
            sel.innerHTML = '<option value="">-- è¨ªå®¢ --</option>';
            customers.forEach(c => sel.innerHTML += `<option value="${c.id}">${c.name}</option>`);
            const chips = document.getElementById('shop-cat-chips');
            chips.innerHTML = `<button onclick="setShopCat('All')" class="px-4 py-1 rounded-full text-xs font-bold ${currentShopCategory==='All'?'chip-active':'chip-inactive'}">å…¨éƒ¨</button>`;
            categories.forEach(c => chips.innerHTML += `<button onclick="setShopCat('${c}')" class="px-4 py-1 rounded-full text-xs font-bold ${currentShopCategory===c?'chip-active':'chip-inactive'}">${c}</button>`);
            renderShopProds();
            calculateTotal();
        }
        function setShopCat(c) { currentShopCategory = c; initShop(); }
        function renderShopProds() {
            const list = document.getElementById('shop-product-list');
            list.innerHTML = '';
            products.filter(p => !p.hidden && (currentShopCategory==='All' || p.category===currentShopCategory)).forEach(p => {
                if(!cart[p.id]) cart[p.id] = 0;
                const el = document.createElement('div');
                el.className = 'bg-white p-4 rounded-xl flex justify-between items-center';
                el.innerHTML = `<div><div class="font-bold">${p.name}</div><div class="text-orange-500">$${p.price}</div></div><div class="flex items-center gap-3"><button onclick="updCart('${p.id}',-1)">-</button><span id="q-${p.id}">${cart[p.id]}</span><button onclick="updCart('${p.id}',1)">+</button></div>`;
                list.appendChild(el);
            });
        }
        function updCart(id, d) { cart[id] = Math.max(0, (cart[id]||0) + d); document.getElementById(`q-${id}`).textContent = cart[id]; calculateTotal(); }
        function calculateTotal() {
            let sub = 0; products.forEach(p => sub += (cart[p.id]||0) * p.price);
            const rate = parseInt(document.getElementById('discount-rate').value) || 100;
            const method = document.querySelector('input[name="round"]:checked').value;
            let final = sub * (rate / 100);
            if(method==='floor') final = Math.floor(final); else if(method==='ceil') final = Math.ceil(final); else final = Math.round(final);
            document.getElementById('cart-total').textContent = final;
            return final;
        }
        function updateShopBalance() {
            const id = document.getElementById('shop-cust-select').value;
            const b = document.getElementById('shop-balance-display');
            if(id) { const c = customers.find(x => x.id==id); b.textContent = `é¤˜é¡: $${c.balance}`; } else b.textContent = '';
        }
        function processCheckout() {
            const total = calculateTotal(); if(total <= 0) return;
            const custId = document.getElementById('shop-cust-select').value;
            const pay = document.getElementById('payment-method').value;
            let cName = 'è¨ªå®¢';
            if(pay==='stored') {
                if(!custId) return alert('è«‹é¸æœƒå“¡');
                const idx = customers.findIndex(c => c.id == custId);
                if(customers[idx].balance < total) return alert('é¤˜é¡ä¸è¶³');
                customers[idx].balance -= total;
                cName = customers[idx].name;
            }
            const rec = { id: Date.now().toString(), date: new Date().toLocaleString(), type: 'purchase', custName: cName, amount: total, details: 'è³¼è²·å•†å“', paymentMethod: pay };
            transactions.unshift(rec);
            saveAllToLocal();
            showResultModal('çµå¸³æˆåŠŸ', `é‡‘é¡ï¼š${total}\nä»˜æ¬¾ï¼š${pay}`);
            syncToGoogleSheet('purchase', rec);
            cart = {}; initShop();
        }

        // --- HISTORY ---
        function renderHistory() {
            const list = document.getElementById('history-list');
            list.innerHTML = '';
            transactions.slice(0, 20).forEach(t => {
                const el = document.createElement('div');
                el.className = 'bg-white p-3 rounded-xl text-xs';
                el.innerHTML = `<div class="flex justify-between font-bold"><span>${t.custName}</span><span>$${t.amount}</span></div><div class="text-gray-400">${t.date}</div>`;
                list.appendChild(el);
            });
        }

        // --- MODAL & UTILS ---
        function showResultModal(title, text) { document.querySelector('#result-modal h3').textContent = title; document.getElementById('copy-target').value = text; document.getElementById('result-modal').classList.remove('hidden'); }
        function closeModal() { document.getElementById('result-modal').classList.add('hidden'); }
        function copyText() { navigator.clipboard.writeText(document.getElementById('copy-target').value); alert('å·²è¤‡è£½'); }

        async function syncToGoogleSheet(action, data) {
            if(!appSettings.sheetUrl) return;
            const payload = new URLSearchParams();
            payload.append('action', action);
            payload.append('data', JSON.stringify(data));
            try {
                await fetch(appSettings.sheetUrl, { method: 'POST', mode: 'no-cors', body: payload });
            } catch (e) {}
        }

        // Init UI
        document.getElementById('gsheet-url').value = appSettings.sheetUrl;
    </script>
</body>
</html>